{% extends "base.html" %}
{% block content %}
<div class="bg-white p-6 rounded-xl shadow max-w-md mx-auto">
  <h2 class="text-xl font-bold mb-4">Log Study Session</h2>
  
    <form method="POST" id="logForm">
  <!-- Select is for UI only -->
  <select id="topic" class="w-full p-3 border rounded mb-4" required>
    <option value="">-- Select Topic --</option>
    <option value="Python">Python</option>
    <option value="Machine Learning">Machine Learning</option>
    <option value="Web Dev">Web Dev</option>
    <option value="Math">Math</option>
    <option value="Physics">Physics</option>
    <option value="English">English</option>
    <option value="Other">Other</option>
  </select>

  <div id="otherTopicContainer" class="hidden mb-4">
    <input type="text" id="otherTopicInput" placeholder="Enter custom topic..." 
           class="w-full p-3 border rounded">
  </div>

  <input type="number" name="minutes" id="minutes" min="1" value="30" 
         class="w-full p-3 border rounded mb-4" required>

  <input type="date" name="log_date" value="{{ today }}" 
         class="w-full p-3 border rounded mb-6">

  <!-- Hidden input will hold final topic -->
  <input type="hidden" name="topic" id="finalTopic" value="">

  <div class="flex gap-2">
    <button type="submit" class="flex-1 bg-green-600 text-white p-3 rounded font-bold">
      Log Session
    </button>
    <button type="button" id="voiceBtn" class="bg-blue-600 text-white p-3 rounded font-bold flex items-center gap-2">
      (mic) Speak
    </button>
  </div>
</form>

  <p id="transcript" class="mt-4 text-sm text-gray-600"></p>
</div>

<script>
// === UI: Show/hide "Other" input ===
const topicSelect = document.getElementById('topic');
const otherContainer = document.getElementById('otherTopicContainer');
const otherInput = document.getElementById('otherTopicInput');
const logForm = document.getElementById('logForm');
const transcript = document.getElementById('transcript');

// Show Other input when needed
topicSelect.addEventListener('change', updateTopicField);
function updateTopicField() {
  if (topicSelect.value === 'Other') {
    otherContainer.classList.remove('hidden');
    otherInput.required = true;
  } else {
    otherContainer.classList.add('hidden');
    otherInput.required = false;
    otherInput.value = '';
  }
  syncHiddenTopic();
}

// === Sync hidden input with selected/final topic ===
function syncHiddenTopic() {
  let finalTopic = topicSelect.value;
  if (finalTopic === 'Other') {
    finalTopic = otherInput.value.trim();
    if (!finalTopic) return; // wait for user
  }

  // Remove old hidden input
  const oldHidden = document.getElementById('finalTopic');
  if (oldHidden) oldHidden.remove();

  // Add new hidden input
  const hiddenInput = document.createElement('input');
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'topic';
  hiddenInput.id = 'finalTopic';
  hiddenInput.value = finalTopic;
  logForm.appendChild(hiddenInput);
}

// Run on load & change
updateTopicField();
topicSelect.addEventListener('change', () => {
  updateTopicField();
  setTimeout(syncHiddenTopic, 100); // small delay for Other input
});
otherInput.addEventListener('input', syncHiddenTopic);

// === Voice Recognition ===
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'en-US';
recognition.interimResults = false;

document.getElementById('voiceBtn').addEventListener('click', () => {
  document.getElementById('voiceBtn').innerHTML = 'Listening...';
  transcript.innerText = '';
  recognition.start();
});

recognition.onresult = (event) => {
  const text = event.results[0][0].transcript.toLowerCase().trim();
  transcript.innerText = `Heard: "${text}"`;

  const match = text.match(/(\d+)\s*(min|mins|minute|minutes)?\s*(.+)/i);
  if (!match) {
    transcript.innerText = 'Try: "Log 45 min Python"';
    return;
  }

  const minutes = match[1];
  let rawTopic = match[3].trim();
  let topic = rawTopic.charAt(0).toUpperCase() + rawTopic.slice(1);

  // Set minutes
  document.getElementById('minutes').value = minutes;

  // Try to match known topic
  let found = false;
  for (let opt of topicSelect.options) {
    if (opt.value && (
      opt.value.toLowerCase().includes(topic.toLowerCase()) ||
      topic.toLowerCase().includes(opt.value.toLowerCase())
    )) {
      topicSelect.value = opt.value;
      found = true;
      break;
    }
  }

  if (!found) {
    topicSelect.value = 'Other';
    otherInput.value = topic;
    otherContainer.classList.remove('hidden');
    otherInput.required = true;
  }

  // Update UI + hidden field
  updateTopicField();
  setTimeout(syncHiddenTopic, 200);

  // Auto-submit
  setTimeout(() => logForm.submit(), 1200);
};

recognition.onerror = () => {
  document.getElementById('voiceBtn').innerHTML = 'Speak';
  transcript.innerText = 'Voice error. Try again.';
};

recognition.onend = () => {
  document.getElementById('voiceBtn').innerHTML = 'Speak';
};

// === Manual submit: ensure hidden field is set ===
logForm.addEventListener('submit', (e) => {
  syncHiddenTopic();
  const finalTopic = document.getElementById('finalTopic')?.value;
  if (!finalTopic) {
    e.preventDefault();
    flash("Please select or enter a topic.");
  }
});
</script>

<style>
.hidden { display: none; }
</style>
{% endblock %}