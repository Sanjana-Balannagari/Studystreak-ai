{% extends "base.html" %}
{% block content %}
<div class="bg-white p-6 rounded-xl shadow">
  <h2 class="text-2xl font-bold mb-4">Welcome, {{ current_user.email }}!</h2>
  
  <!-- Streak + Badge -->
  <div class="text-center mb-6">
    <h3 id="streak" class="text-3xl sm:text-4xl font-bold text-green-600">
      {{ streak }} days ðŸ”¥
    </h3>
    <p class="text-gray-600">Current Streak</p>
    
    {% if badge %}
      <div class="mt-2 inline-block bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg font-bold">
        Awarded: {{ badge }}
      </div>
    {% endif %}
  </div>

  <!-- Calendar Heatmap -->
  <div id="calendar" class="grid grid-cols-7 gap-1 mt-6"></div>

  <div class="mt-6 grid grid-cols-2 gap-4 text-center">
    <div class="bg-gray-50 p-4 rounded">
      <p class="text-2xl font-bold" id="total-hrs">0</p>
      <p class="text-sm text-gray-600">Total Hours</p>
    </div>
    <div class="bg-gray-50 p-4 rounded">
      <p class="text-2xl font-bold" id="top-topic">-</p>
      <p class="text-sm text-gray-600">Top Topic</p>
    </div>
  </div>
</div>

<script>
async function loadDashboard() {
  const [streakRes, logsRes] = await Promise.all([
    fetch('/api/streak'), fetch('/api/logs')
  ]);
  const streak = await streakRes.json();
  const logs = await logsRes.json();

  // Update streak text dynamically
  document.getElementById('streak').innerText = streak.streak + " days ðŸ”¥";

  // Map of date â†’ minutes
  const logMap = {};
  logs.forEach(log => {
    logMap[log.log_date] = (logMap[log.log_date] || 0) + log.minutes;
  });

  // Generate last 30 days calendar (7 columns = weeks)
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = "";
  const today = new Date();

  for (let i = 29; i >= 0; i--) {
    const d = new Date();
    d.setDate(today.getDate() - i);
    const iso = d.toISOString().split("T")[0];
    const mins = logMap[iso] || 0;

    // Shade of green based on minutes
    let color = "bg-gray-200"; // no study
    if (mins > 0 && mins < 30) color = "bg-green-200";
    else if (mins >= 30 && mins < 60) color = "bg-green-400";
    else if (mins >= 60 && mins < 120) color = "bg-green-600";
    else if (mins >= 120) color = "bg-green-800";

    const cell = document.createElement("div");
    cell.className = `${color} w-8 h-8 rounded`;
    cell.title = `${iso}: ${mins} min`;
    calendar.appendChild(cell);
  }

  // Stats
  const totalMins = logs.reduce((a, b) => a + b.minutes, 0);
  document.getElementById('total-hrs').innerText = (totalMins / 60).toFixed(1);

  const topics = {};
  logs.forEach(l => topics[l.topic] = (topics[l.topic] || 0) + l.minutes);
  const top = Object.entries(topics).sort((a,b) => b[1]-a[1])[0];
  if (top) document.getElementById('top-topic').innerText = `${top[0]} (${Math.round(top[1]/totalMins*100)}%)`;
}

loadDashboard();
</script>
{% endblock %}
